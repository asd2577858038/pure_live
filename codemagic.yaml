workflows:
  ios-trollstore:
    name: æ„å»º iOS IPA (ä¿®å¤ç‰ˆ)
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      # ç¬¬1æ­¥: æš´åŠ›æ¸…ç†ç¯å¢ƒ & è·å–ä¾èµ–
      - name: ç¬¬1æ­¥ - æ¸…ç†ä¸è·å–ä¾èµ–
        script: |
          echo "ğŸ§¹ å¼€å§‹æ·±åº¦æ¸…ç†..."
          # 1. æ¸…ç† Flutter ç¼“å­˜
          flutter clean
          
          # 2. åˆ é™¤ iOS æ‰€æœ‰çš„ç”Ÿæˆæ–‡ä»¶
          rm -rf ios/Pods
          rm -rf ios/Podfile.lock
          rm -rf ios/.symlinks
          rm -rf ios/Flutter/Flutter.framework
          rm -rf ios/Flutter/App.framework
          
          echo "ğŸ“¦ è·å– Flutter ä¾èµ–..."
          # ä½¿ç”¨ pub upgrade ç¡®ä¿è·å–å…¼å®¹çš„æœ€æ–°ç‰ˆæœ¬
          flutter pub upgrade
          flutter pub get
      
      # ç¬¬2æ­¥: ä¿®æ­£ Podfile (å…³é”®æ­¥éª¤!)
      # æˆ‘ä»¬åŠ¨æ€ä¿®æ”¹ Podfileï¼Œå¼ºåˆ¶å°†æ‰€æœ‰æ’ä»¶çš„ iOS ç‰ˆæœ¬æå‡åˆ° 13.0
      # è¿™æ ·å¯ä»¥è§£å†³æ»¡å±çš„ "deployment target" è­¦å‘Šå’Œæ½œåœ¨çš„æ„å»ºå¤±è´¥
      - name: ç¬¬2æ­¥ - ä¿®æ­£ Podfile é…ç½®
        script: |
          echo "ğŸ”§ ä¿®æ­£ iOS Deployment Target..."
          cd ios
          
          # å¦‚æœ Podfile é‡Œé¢æ²¡æœ‰ post_installï¼Œæˆ‘ä»¬è¿½åŠ ä¸€æ®µè„šæœ¬
          # è¿™æ®µ Ruby ä»£ç ä¼šå¼ºåˆ¶æŠŠæ‰€æœ‰ç¬¬ä¸‰æ–¹åº“çš„æœ€ä½æ”¯æŒç‰ˆæœ¬æ”¹ä¸º iOS 13.0
          cat <<EOF >> Podfile

          post_install do |installer|
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
                # è§£å†³éƒ¨åˆ†åº“çš„ç­¾åé—®é¢˜
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
              end
            end
          end
          EOF
          
          echo "âœ… Podfile ä¿®æ­£å®Œæˆ"

      # ç¬¬3æ­¥: å®‰è£… iOS ä¾èµ–
      - name: ç¬¬3æ­¥ - å®‰è£… Pods
        script: |
          echo "ğŸ¥¥ å®‰è£… CocoaPods..."
          cd ios
          # æ›´æ–°æœ¬åœ°ä»“åº“ç´¢å¼•
          pod repo update
          # å®‰è£…ä¾èµ–
          pod install --repo-update
      
      # ç¬¬4æ­¥: ç¼–è¯‘åº”ç”¨
      - name: ç¬¬4æ­¥ - ç¼–è¯‘ iOS
        script: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘..."
          # å¢åŠ  --release å’Œ --no-codesign
          flutter build ios --release --no-codesign
      
      # ç¬¬5æ­¥: æ‰“åŒ… IPA
      - name: ç¬¬5æ­¥ - æ‰“åŒ… IPA
        script: |
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…..."
          PROJECT_ROOT=$(pwd)
          BUILD_DIR="$PROJECT_ROOT/build/ios/iphoneos"
          
          if [ -d "$BUILD_DIR/Runner.app" ]; then
            cd "$BUILD_DIR"
            mkdir -p Payload
            cp -r Runner.app Payload/
            # è¿™é‡Œçš„åå­—å¯ä»¥æ”¹ï¼Œæ¯”å¦‚ PureLive_Fixed.ipa
            zip -r "$PROJECT_ROOT/PureLive.ipa" Payload
            echo "âœ… IPA æ‰“åŒ…æˆåŠŸï¼"
          else
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç¼–è¯‘äº§ç‰© Runner.app"
            exit 1
          fi
    
    artifacts:
      - "*.ipa"
    
    publishing:
      email:
        recipients:
          - your-email@example.com # è®°å¾—æ”¹æˆä½ çš„é‚®ç®±
        notify:
          success: true
          failure: true
          fi
          cd ..
          echo "========================================="
      
      - name: ç¦ç”¨ä»£ç ç­¾å
        script: |
          echo "========================================="
          echo "ğŸ”“ ç¦ç”¨ä»£ç ç­¾å"
          echo "========================================="
          
          cd ios
          cp Runner.xcodeproj/project.pbxproj Runner.xcodeproj/project.pbxproj.backup
          
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = ""/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Distribution"/CODE_SIGN_IDENTITY = ""/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*/DEVELOPMENT_TEAM = ""/g' Runner.xcodeproj/project.pbxproj
          
          cd ..
          echo "âœ… ä»£ç ç­¾åå·²ç¦ç”¨"
          echo "========================================="
      
      - name: ç¼–è¯‘ iOS åº”ç”¨
        script: |
          echo "========================================="
          echo "ğŸ”¨ ä½¿ç”¨ xcodebuild ç¼–è¯‘"
          echo "========================================="
          
          cd ios
          
          echo "å¼€å§‹ç¼–è¯‘ (è¿™å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ)..."
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            -allowProvisioningUpdates \
            2>&1 | tee ../xcodebuild.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          cd ..
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            
            if [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
              echo "âœ… Runner.app å·²ç”Ÿæˆ"
              ls -lh build/ios/Release-iphoneos/Runner.app
            else
              echo "æŸ¥æ‰¾ Runner.app ä½ç½®..."
              find build/ios -name "Runner.app" -type d
            fi
          else
            echo ""
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo ""
            echo "é”™è¯¯æ—¥å¿—:"
            tail -200 xcodebuild.log
            exit 1
          fi
          echo "========================================="
      
      - name: æ‰“åŒ…ä¸º IPA
        script: |
          echo "========================================="
          echo "ğŸ“¦ æ‰“åŒ… IPA"
          echo "========================================="
          
          APP_PATH=$(find build/ios -name "Runner.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° Runner.app"
            echo "build/ios ç›®å½•ç»“æ„:"
            find build/ios -type d -maxdepth 3
            exit 1
          fi
          
          echo "æ‰¾åˆ° Runner.app: $APP_PATH"
          
          BUILD_DIR=$(dirname "$APP_PATH")
          cd "$BUILD_DIR"
          
          echo "åˆ›å»º Payload ç»“æ„..."
          mkdir -p Payload
          cp -r Runner.app Payload/
          
          echo "æ‰“åŒ…ä¸º IPA..."
          zip -r -q PureLive-TrollStore.ipa Payload
          
          mv PureLive-TrollStore.ipa "$OLDPWD/"
          rm -rf Payload
          
          cd "$OLDPWD"
          
          if [ -f "PureLive-TrollStore.ipa" ]; then
            echo ""
            echo "âœ… IPA æ‰“åŒ…æˆåŠŸ!"
            echo ""
            echo "ğŸ“± æ–‡ä»¶ä¿¡æ¯:"
            ls -lh PureLive-TrollStore.ipa
            echo ""
            echo "ğŸ“¦ IPA å†…å®¹:"
            unzip -l PureLive-TrollStore.ipa | head -30
            echo ""
            echo "ğŸ‰ å¯ä»¥ç”¨ TrollStore å®‰è£…äº†!"
          else
            echo "âŒ IPA æœªç”Ÿæˆ"
            exit 1
          fi
          echo "========================================="
      
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        script: |
          if [ -f "pubspec.yaml.backup" ]; then
            echo "æ¢å¤åŸå§‹ pubspec.yaml..."
            mv pubspec.yaml.backup pubspec.yaml
          fi
          
          if [ -f "ios/Runner.xcodeproj/project.pbxproj.backup" ]; then
            echo "æ¢å¤åŸå§‹ Xcode é…ç½®..."
            mv ios/Runner.xcodeproj/project.pbxproj.backup ios/Runner.xcodeproj/project.pbxproj
          fi
          
          echo "âœ… æ¸…ç†å®Œæˆ"
    
    artifacts:
      - PureLive-TrollStore.ipa
      - "*.log"
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
