workflows:
  ios-trollstore-build:
    name: iOS TrollStore æ„å»º (æ— ç­¾å)
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: ç¯å¢ƒæ£€æŸ¥
        script: |
          echo "========================================="
          echo "ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ"
          echo "========================================="
          flutter --version
          pod --version
          xcodebuild -version
          echo "========================================="
      
      - name: Flutter å‡†å¤‡
        script: |
          echo "========================================="
          echo "ğŸ“¦ å‡†å¤‡ Flutter ä¾èµ–"
          echo "========================================="
          flutter clean
          flutter pub get
          echo "âœ… Flutter ä¾èµ–å‡†å¤‡å®Œæˆ"
          echo "========================================="
      
      - name: ä¿®å¤ä¾èµ–é—®é¢˜
        script: |
          echo "========================================="
          echo "ğŸ”§ ä¿®å¤ share_handler ä¾èµ–é—®é¢˜"
          echo "========================================="
          
          if grep -q "share_handler" pubspec.yaml; then
            echo "å‘ç° share_handler æ’ä»¶,ä¸´æ—¶ç¦ç”¨..."
            cp pubspec.yaml pubspec.yaml.backup
            sed -i.bak 's/^  share_handler:/#  share_handler:/g' pubspec.yaml
            flutter pub get
            echo "âœ… å·²ä¿®å¤"
          else
            echo "æœªå‘ç°é—®é¢˜æ’ä»¶"
          fi
          echo "========================================="
      
      - name: æ·±åº¦æ¸…ç† CocoaPods
        script: |
          echo "========================================="
          echo "ğŸ§¹ æ·±åº¦æ¸…ç† CocoaPods"
          echo "========================================="
          cd ios
          rm -rf Pods Podfile.lock
          rm -rf ~/Library/Caches/CocoaPods
          rm -rf .symlinks Flutter/Flutter.framework Flutter/Flutter.podspec
          rm -rf ~/Library/Developer/Xcode/DerivedData
          pod cache clean --all 2>/dev/null || true
          cd ..
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo "========================================="
      
      - name: é…ç½® CocoaPods
        script: |
          echo "========================================="
          echo "âš™ï¸  é…ç½® CocoaPods"
          echo "========================================="
          cd ios
          pod repo remove master 2>/dev/null || true
          pod repo add-cdn trunk https://cdn.cocoapods.org/ 2>/dev/null || true
          cd ..
          echo "âœ… é…ç½®å®Œæˆ"
          echo "========================================="
      
      - name: å®‰è£… iOS ä¾èµ–
        script: |
          echo "========================================="
          echo "ğŸ“¦ å®‰è£… iOS ä¾èµ–"
          echo "========================================="
          cd ios
          pod repo update
          pod install --repo-update --verbose 2>&1 | tee ../pod_install.log
          INSTALL_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $INSTALL_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… Pods å®‰è£…æˆåŠŸ"
          else
            echo ""
            echo "âŒ Pods å®‰è£…å¤±è´¥"
            tail -100 ../pod_install.log
            exit 1
          fi
          cd ..
          echo "========================================="
      
      - name: ç¦ç”¨ä»£ç ç­¾å
        script: |
          echo "========================================="
          echo "ğŸ”“ ç¦ç”¨ä»£ç ç­¾å"
          echo "========================================="
          
          cd ios
          cp Runner.xcodeproj/project.pbxproj Runner.xcodeproj/project.pbxproj.backup
          
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = ""/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Distribution"/CODE_SIGN_IDENTITY = ""/g' Runner.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*/DEVELOPMENT_TEAM = ""/g' Runner.xcodeproj/project.pbxproj
          
          cd ..
          echo "âœ… ä»£ç ç­¾åå·²ç¦ç”¨"
          echo "========================================="
      
      - name: ç¼–è¯‘ iOS åº”ç”¨
        script: |
          echo "========================================="
          echo "ğŸ”¨ ä½¿ç”¨ xcodebuild ç¼–è¯‘"
          echo "========================================="
          
          cd ios
          
          echo "å¼€å§‹ç¼–è¯‘ (è¿™å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ)..."
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            -allowProvisioningUpdates \
            2>&1 | tee ../xcodebuild.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          cd ..
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            
            if [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
              echo "âœ… Runner.app å·²ç”Ÿæˆ"
              ls -lh build/ios/Release-iphoneos/Runner.app
            else
              echo "æŸ¥æ‰¾ Runner.app ä½ç½®..."
              find build/ios -name "Runner.app" -type d
            fi
          else
            echo ""
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo ""
            echo "é”™è¯¯æ—¥å¿—:"
            tail -200 xcodebuild.log
            exit 1
          fi
          echo "========================================="
      
      - name: æ‰“åŒ…ä¸º IPA
        script: |
          echo "========================================="
          echo "ğŸ“¦ æ‰“åŒ… IPA"
          echo "========================================="
          
          APP_PATH=$(find build/ios -name "Runner.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° Runner.app"
            echo "build/ios ç›®å½•ç»“æ„:"
            find build/ios -type d -maxdepth 3
            exit 1
          fi
          
          echo "æ‰¾åˆ° Runner.app: $APP_PATH"
          
          BUILD_DIR=$(dirname "$APP_PATH")
          cd "$BUILD_DIR"
          
          echo "åˆ›å»º Payload ç»“æ„..."
          mkdir -p Payload
          cp -r Runner.app Payload/
          
          echo "æ‰“åŒ…ä¸º IPA..."
          zip -r -q PureLive-TrollStore.ipa Payload
          
          mv PureLive-TrollStore.ipa "$OLDPWD/"
          rm -rf Payload
          
          cd "$OLDPWD"
          
          if [ -f "PureLive-TrollStore.ipa" ]; then
            echo ""
            echo "âœ… IPA æ‰“åŒ…æˆåŠŸ!"
            echo ""
            echo "ğŸ“± æ–‡ä»¶ä¿¡æ¯:"
            ls -lh PureLive-TrollStore.ipa
            echo ""
            echo "ğŸ“¦ IPA å†…å®¹:"
            unzip -l PureLive-TrollStore.ipa | head -30
            echo ""
            echo "ğŸ‰ å¯ä»¥ç”¨ TrollStore å®‰è£…äº†!"
          else
            echo "âŒ IPA æœªç”Ÿæˆ"
            exit 1
          fi
          echo "========================================="
      
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        script: |
          if [ -f "pubspec.yaml.backup" ]; then
            echo "æ¢å¤åŸå§‹ pubspec.yaml..."
            mv pubspec.yaml.backup pubspec.yaml
          fi
          
          if [ -f "ios/Runner.xcodeproj/project.pbxproj.backup" ]; then
            echo "æ¢å¤åŸå§‹ Xcode é…ç½®..."
            mv ios/Runner.xcodeproj/project.pbxproj.backup ios/Runner.xcodeproj/project.pbxproj
          fi
          
          echo "âœ… æ¸…ç†å®Œæˆ"
    
    artifacts:
      - PureLive-TrollStore.ipa
      - "*.log"
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
