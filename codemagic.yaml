workflows:
  ios-trollstore:
    name: æ„å»º iOS IPA (TrollStore ç‰ˆ)
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        # å¦‚æœéœ€è¦å¯ä»¥åœ¨è¿™é‡Œå®šä¹‰ç¯å¢ƒå˜é‡
        FLUTTER_VERSION: "stable"
    
    scripts:
      - name: ç¬¬1æ­¥ - æ¸…ç†ç¯å¢ƒ
        script: |
          echo "ğŸ§¹ æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶..."
          flutter clean
          cd ios
          rm -rf Pods Podfile.lock .symlinks
          cd ..
      
      - name: ç¬¬2æ­¥ - è·å– Flutter ä¾èµ–
        script: |
          echo "ğŸ“¦ è·å– Flutter ä¾èµ–..."
          flutter pub get
          
          # éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
          if [ ! -d ".dart_tool" ]; then
            echo "âŒ Flutter ä¾èµ–è·å–å¤±è´¥"
            exit 1
          fi
          echo "âœ… Flutter ä¾èµ–è·å–æˆåŠŸ"
      
      - name: ç¬¬3æ­¥ - ç”Ÿæˆ iOS é…ç½®
        script: |
          echo "âš™ï¸  ç”Ÿæˆ iOS é…ç½®æ–‡ä»¶..."
          cd ios
          
          # æ£€æŸ¥ Podfile
          if [ ! -f "Podfile" ]; then
            echo "âŒ Podfile ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸ“„ Podfile å†…å®¹:"
          cat Podfile
          
          # æ›´æ–° CocoaPods ä»“åº“
          echo "ğŸ”„ æ›´æ–° CocoaPods ä»“åº“..."
          pod repo update
          
          # å®‰è£… CocoaPods ä¾èµ–
          echo "ğŸ“¦ å®‰è£… CocoaPods ä¾èµ–..."
          pod install --repo-update --verbose
          
          # éªŒè¯ Pods å®‰è£…
          if [ ! -d "Pods" ]; then
            echo "âŒ CocoaPods ä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # éªŒè¯ workspace
          if [ ! -f "Runner.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âŒ Xcode workspace åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          cd ..
          echo "âœ… iOS é…ç½®ç”ŸæˆæˆåŠŸ"
          echo "ğŸ“‚ ios ç›®å½•ç»“æ„:"
          ls -la ios/
      
      - name: ç¬¬4æ­¥ - æ„å»º iOS åº”ç”¨
        script: |
          echo "ğŸ”¨ å¼€å§‹æ„å»º iOS åº”ç”¨..."
          
          # ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
          PROJECT_ROOT=$(pwd)
          echo "ğŸ“ å½“å‰ç›®å½•: $PROJECT_ROOT"
          
          # æ£€æŸ¥ ios ç›®å½•å’Œ workspace
          if [ ! -d "ios" ]; then
            echo "âŒ ios ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f "ios/Runner.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âŒ Xcode workspace ä¸å­˜åœ¨ï¼ŒCocoaPods å¯èƒ½å®‰è£…å¤±è´¥"
            exit 1
          fi
          
          # æ„å»º iOS åº”ç”¨ï¼ˆä¸ç­¾åï¼‰
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          flutter build ios \
            --release \
            --no-codesign \
            --verbose
          
          # éªŒè¯æ„å»ºäº§ç‰©
          echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©..."
          if [ ! -d "build/ios/iphoneos/Runner.app" ]; then
            echo "âŒ iOS åº”ç”¨æ„å»ºå¤±è´¥ - Runner.app ä¸å­˜åœ¨"
            echo "ğŸ“‚ å½“å‰ç›®å½•ç»“æ„:"
            ls -la build/ 2>/dev/null || echo "build ç›®å½•ä¸å­˜åœ¨"
            ls -la build/ios/ 2>/dev/null || echo "build/ios ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… iOS åº”ç”¨æ„å»ºæˆåŠŸ"
          echo "ğŸ“‚ æ„å»ºäº§ç‰©:"
          ls -lh build/ios/iphoneos/Runner.app
      
      - name: ç¬¬5æ­¥ - æ‰“åŒ… IPA
        script: |
          echo "ğŸ“¦ æ‰“åŒ… IPA æ–‡ä»¶..."
          
          # è®¾ç½®ä¸¥æ ¼æ¨¡å¼
          set -e
          
          PROJECT_ROOT=$(pwd)
          BUILD_DIR="$PROJECT_ROOT/build/ios/iphoneos"
          IPA_NAME="PureLive_$(date +%Y%m%d_%H%M%S).ipa"
          
          echo "ğŸ“ é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"
          echo "ğŸ“ æ„å»ºç›®å½•: $BUILD_DIR"
          
          # å†æ¬¡éªŒè¯æ„å»ºäº§ç‰©å­˜åœ¨
          if [ ! -d "$BUILD_DIR/Runner.app" ]; then
            echo "âŒ é”™è¯¯: Runner.app ä¸å­˜åœ¨"
            echo "ğŸ“‚ æ£€æŸ¥ç›®å½•ç»“æ„:"
            ls -la "$PROJECT_ROOT/build/" 2>/dev/null || echo "build ç›®å½•ä¸å­˜åœ¨"
            ls -la "$PROJECT_ROOT/build/ios/" 2>/dev/null || echo "build/ios ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è¿›å…¥æ„å»ºç›®å½•
          cd "$BUILD_DIR"
          echo "ğŸ“ å·²åˆ‡æ¢åˆ°: $(pwd)"
          
          # æ¸…ç†å¹¶åˆ›å»º Payload ç›®å½•
          rm -rf Payload
          mkdir -p Payload
          
          # å¤åˆ¶ app åˆ° Payload
          echo "ğŸ“‹ å¤åˆ¶ Runner.app åˆ° Payload..."
          cp -r Runner.app Payload/
          
          # éªŒè¯å¤åˆ¶æˆåŠŸ
          if [ ! -d "Payload/Runner.app" ]; then
            echo "âŒ å¤åˆ¶ Runner.app å¤±è´¥"
            exit 1
          fi
          
          # æ‰“åŒ…æˆ IPA
          echo "ğŸ—œï¸  å‹ç¼© IPA..."
          zip -r "$PROJECT_ROOT/$IPA_NAME" Payload
          
          # è¿”å›é¡¹ç›®æ ¹ç›®å½•
          cd "$PROJECT_ROOT"
          
          # éªŒè¯ IPA æ–‡ä»¶
          if [ ! -f "$IPA_NAME" ]; then
            echo "âŒ IPA æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          
          # æ˜¾ç¤º IPA ä¿¡æ¯
          echo "âœ… IPA æ‰“åŒ…æˆåŠŸ!"
          echo "ğŸ“¦ æ–‡ä»¶å: $IPA_NAME"
          ls -lh "$IPA_NAME"
          
          # åˆ›å»ºä¸€ä¸ªå›ºå®šåç§°çš„å‰¯æœ¬ï¼Œæ–¹ä¾¿ä¸‹è½½
          cp "$IPA_NAME" PureLive.ipa
          echo "ğŸ“¦ å·²åˆ›å»ºå‰¯æœ¬: PureLive.ipa"
    
    artifacts:
      - "*.ipa"
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
      
      # å¯é€‰ï¼šæ·»åŠ å…¶ä»–å‘å¸ƒæ–¹å¼
      # app_store_connect:
      #   api_key: $APP_STORE_CONNECT_KEY_ID
      #   key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
      #   issuer_id: $APP_STORE_CONNECT_ISSUER_ID
