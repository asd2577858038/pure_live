workflows:
  ios-trollstore:
    name: æ„å»º iOS IPA (TrollStore ç‰ˆ)
    max_build_duration: 120
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        COCOAPODS_DISABLE_STATS: "true"
    
    scripts:
      - name: æ­¥éª¤1 - ç¯å¢ƒä¿¡æ¯
        script: |
          set -e
          echo "ğŸ”§ æ„å»ºç¯å¢ƒä¿¡æ¯..."
          flutter --version
          xcodebuild -version
          pod --version
          ruby --version
          echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"
          
      - name: æ­¥éª¤2 - æ¸…ç†ç¯å¢ƒ
        script: |
          set -e
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ..."
          flutter clean
          cd ios
          rm -rf Pods Podfile.lock .symlinks build DerivedData
          cd ..
          echo "âœ… æ¸…ç†å®Œæˆ"
      
      - name: æ­¥éª¤3 - å®Œå…¨é‡å»º CocoaPods
        script: |
          set -e
          echo "ğŸ”„ å®Œå…¨é‡å»º CocoaPods specs..."
          
          # åˆ é™¤æ‰€æœ‰ CocoaPods ç¼“å­˜å’Œä»“åº“
          rm -rf ~/.cocoapods
          rm -rf ~/Library/Caches/CocoaPods
          
          # é‡æ–°åˆå§‹åŒ–ï¼ˆä¼šä» CDN ä¸‹è½½æœ€æ–° specsï¼‰
          pod setup
          
          echo "âœ… CocoaPods é‡å»ºå®Œæˆ"
      
      - name: æ­¥éª¤4 - è·å– Flutter ä¾èµ–
        script: |
          set -e
          echo "ğŸ“¦ è·å– Flutter ä¾èµ–..."
          flutter pub get
          
          if [ ! -d ".dart_tool" ]; then
            echo "âŒ ä¾èµ–è·å–å¤±è´¥"
            exit 1
          fi
          echo "âœ… ä¾èµ–è·å–æˆåŠŸ"
      
      - name: æ­¥éª¤5 - ç¡®ä¿ Podfile ä½¿ç”¨ CDN
        script: |
          set -e
          cd ios
          
          echo "ğŸ“ é…ç½® Podfile..."
          
          # å¤‡ä»½
          cp Podfile Podfile.backup
          
          # ç¡®ä¿ä½¿ç”¨ CDN æº
          if ! grep -q "source 'https://cdn.cocoapods.org/'" Podfile; then
            echo "æ·»åŠ  CDN æºåˆ° Podfile..."
            echo "source 'https://cdn.cocoapods.org/'" | cat - Podfile > Podfile.tmp
            mv Podfile.tmp Podfile
          fi
          
          echo "ğŸ“„ Podfile å‰10è¡Œ:"
          head -10 Podfile
          
          cd ..
          echo "âœ… Podfile é…ç½®å®Œæˆ"
      
      - name: æ­¥éª¤6 - ç”Ÿæˆ Flutter æ’ä»¶æ³¨å†Œ
        script: |
          set -e
          echo "ğŸ”§ ç”Ÿæˆ Flutter æ’ä»¶æ³¨å†Œ..."
          
          # é‡æ–°ç”Ÿæˆæ’ä»¶æ³¨å†Œæ–‡ä»¶
          cd ios
          flutter pub get
          cd ..
          
          # éªŒè¯ GeneratedPluginRegistrant.m
          if [ ! -f "ios/Runner/GeneratedPluginRegistrant.m" ]; then
            echo "âŒ GeneratedPluginRegistrant.m æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "ğŸ“„ GeneratedPluginRegistrant.m å‰30è¡Œ:"
          head -30 ios/Runner/GeneratedPluginRegistrant.m
          
          echo "âœ… æ’ä»¶æ³¨å†Œç”Ÿæˆå®Œæˆ"
      
      - name: æ­¥éª¤7 - æ‰‹åŠ¨è¿è¡Œ pod install
        script: |
          set -e
          cd ios
          
          echo "ğŸ“¦ æ‰‹åŠ¨å®‰è£… CocoaPods ä¾èµ–..."
          echo "â° è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ..."
          
          # æ‰‹åŠ¨è¿è¡Œ pod install
          pod install --repo-update --verbose 2>&1 | tee pod_install.log
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ ! -d "Pods" ]; then
            echo "âŒ Pod å®‰è£…å¤±è´¥"
            echo "ğŸ“„ æœ€å100è¡Œæ—¥å¿—:"
            tail -100 pod_install.log
            exit 1
          fi
          
          if [ ! -f "Runner.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âŒ Workspace åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ’ä»¶æ˜¯å¦å®‰è£…
          echo "ğŸ” æ£€æŸ¥å…³é”®æ’ä»¶:"
          ls -la Pods/ | grep -E "app_links|fijkplayer" || echo "âš ï¸ æŸäº›æ’ä»¶å¯èƒ½æœªå®‰è£…"
          
          echo "âœ… Pod å®‰è£…æˆåŠŸ"
          
          cd ..
      
      - name: æ­¥éª¤8 - ä½¿ç”¨ flutter build æ„å»º
        script: |
          set -e
          
          echo "ğŸ”¨ ä½¿ç”¨ Flutter æ„å»º iOS..."
          
          # ä½¿ç”¨ flutter build ç¡®ä¿æ‰€æœ‰ä¸œè¥¿éƒ½æ­£ç¡®
          flutter build ios \
            --release \
            --no-codesign \
            --verbose \
            2>&1 | tee flutter_build.log
          
          # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
          if [ ! -d "build/ios/iphoneos/Runner.app" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ - Runner.app ä¸å­˜åœ¨"
            echo "ğŸ“„ æœ€å100è¡Œæ—¥å¿—:"
            tail -100 flutter_build.log
            exit 1
          fi
          
          echo "âœ… æ„å»ºæˆåŠŸ"
          echo "ğŸ“‚ æ„å»ºäº§ç‰©:"
          ls -lh build/ios/iphoneos/Runner.app
      
      - name: æ­¥éª¤9 - æ‰“åŒ… IPA
        script: |
          set -e
          
          echo "ğŸ“¦ æ‰“åŒ… IPA..."
          
          PROJECT_ROOT=$(pwd)
          BUILD_DIR="$PROJECT_ROOT/build/ios/iphoneos"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          IPA_NAME="PureLive_${TIMESTAMP}.ipa"
          
          # éªŒè¯ app å­˜åœ¨
          if [ ! -d "$BUILD_DIR/Runner.app" ]; then
            echo "âŒ Runner.app ä¸å­˜åœ¨"
            exit 1
          fi
          
          cd "$BUILD_DIR"
          
          # åˆ›å»º Payload
          rm -rf Payload
          mkdir -p Payload
          cp -r Runner.app Payload/
          
          # æ‰“åŒ…
          echo "ğŸ—œï¸  å‹ç¼©..."
          zip -r "$PROJECT_ROOT/$IPA_NAME" Payload -q
          
          cd "$PROJECT_ROOT"
          
          # éªŒè¯
          if [ ! -f "$IPA_NAME" ]; then
            echo "âŒ IPA æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          
          # åˆ›å»ºå›ºå®šåç§°å‰¯æœ¬
          cp "$IPA_NAME" PureLive.ipa
          
          echo "âœ… æ‰“åŒ…æˆåŠŸ!"
          echo "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
          ls -lh *.ipa
    
    artifacts:
      - "*.ipa"
      - "ios/pod_install.log"
      - "flutter_build.log"
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
