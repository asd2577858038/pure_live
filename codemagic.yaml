workflows:
  ios-trollstore:
    name: PureLive TrollStore Build
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      - name: ç¬¬1æ­¥ - è·å–ä¾èµ–
        script: |
          flutter clean
          flutter pub get
          flutter precache --ios

      - name: ç¬¬2æ­¥ - æ³¨å…¥ Podfile ä¿®å¤è„šæœ¬
        script: |
          cd ios
          echo "post_install do |installer|" >> Podfile
          echo "  installer.pods_project.targets.each do |target|" >> Podfile
          echo "    target.build_configurations.each do |config|" >> Podfile
          echo "      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'" >> Podfile
          echo "      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'" >> Podfile
          echo "    end" >> Podfile
          echo "  end" >> Podfile
          echo "end" >> Podfile

      - name: ç¬¬3æ­¥ - å®‰è£… Pods
        script: |
          cd ios
          pod repo update
          pod install --repo-update

      - name: ç¬¬4æ­¥ - ç¼–è¯‘åº”ç”¨
        script: |
          flutter build ios --release --no-codesign

      - name: ç¬¬5æ­¥ - æ‰“åŒ… IPA
        script: |
          PROJECT_ROOT=$(pwd)
          BUILD_DIR="$PROJECT_ROOT/build/ios/iphoneos"
          if [ -d "$BUILD_DIR/Runner.app" ]; then
            cd "$BUILD_DIR"
            mkdir -p Payload
            cp -r Runner.app Payload/
            zip -r "$PROJECT_ROOT/PureLive.ipa" Payload
          else
            echo "Build product not found"
            exit 1
          fi

    artifacts:
      - "*.ipa"

    publishing:
      email:
        recipients:
          - your-email@example.com
          cd ios
          
          echo "å¼€å§‹ç¼–è¯‘ (è¿™å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ)..."
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            -allowProvisioningUpdates \
            2>&1 | tee ../xcodebuild.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          cd ..
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            
            if [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
              echo "âœ… Runner.app å·²ç”Ÿæˆ"
              ls -lh build/ios/Release-iphoneos/Runner.app
            else
              echo "æŸ¥æ‰¾ Runner.app ä½ç½®..."
              find build/ios -name "Runner.app" -type d
            fi
          else
            echo ""
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo ""
            echo "é”™è¯¯æ—¥å¿—:"
            tail -200 xcodebuild.log
            exit 1
          fi
          echo "========================================="
      
      - name: æ‰“åŒ…ä¸º IPA
        script: |
          echo "========================================="
          echo "ğŸ“¦ æ‰“åŒ… IPA"
          echo "========================================="
          
          APP_PATH=$(find build/ios -name "Runner.app" -type d | head -1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° Runner.app"
            echo "build/ios ç›®å½•ç»“æ„:"
            find build/ios -type d -maxdepth 3
            exit 1
          fi
          
          echo "æ‰¾åˆ° Runner.app: $APP_PATH"
          
          BUILD_DIR=$(dirname "$APP_PATH")
          cd "$BUILD_DIR"
          
          echo "åˆ›å»º Payload ç»“æ„..."
          mkdir -p Payload
          cp -r Runner.app Payload/
          
          echo "æ‰“åŒ…ä¸º IPA..."
          zip -r -q PureLive-TrollStore.ipa Payload
          
          mv PureLive-TrollStore.ipa "$OLDPWD/"
          rm -rf Payload
          
          cd "$OLDPWD"
          
          if [ -f "PureLive-TrollStore.ipa" ]; then
            echo ""
            echo "âœ… IPA æ‰“åŒ…æˆåŠŸ!"
            echo ""
            echo "ğŸ“± æ–‡ä»¶ä¿¡æ¯:"
            ls -lh PureLive-TrollStore.ipa
            echo ""
            echo "ğŸ“¦ IPA å†…å®¹:"
            unzip -l PureLive-TrollStore.ipa | head -30
            echo ""
            echo "ğŸ‰ å¯ä»¥ç”¨ TrollStore å®‰è£…äº†!"
          else
            echo "âŒ IPA æœªç”Ÿæˆ"
            exit 1
          fi
          echo "========================================="
      
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        script: |
          if [ -f "pubspec.yaml.backup" ]; then
            echo "æ¢å¤åŸå§‹ pubspec.yaml..."
            mv pubspec.yaml.backup pubspec.yaml
          fi
          
          if [ -f "ios/Runner.xcodeproj/project.pbxproj.backup" ]; then
            echo "æ¢å¤åŸå§‹ Xcode é…ç½®..."
            mv ios/Runner.xcodeproj/project.pbxproj.backup ios/Runner.xcodeproj/project.pbxproj
          fi
          
          echo "âœ… æ¸…ç†å®Œæˆ"
    
    artifacts:
      - PureLive-TrollStore.ipa
      - "*.log"
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
