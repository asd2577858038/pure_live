workflows:
  # iOS TrollStore æ„å»º - è‡ªåŠ¨ä¿®å¤ç‰ˆ
  ios-trollstore-build:
    name: iOS TrollStore æ„å»º (è‡ªåŠ¨ä¿®å¤)
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    
    scripts:
      # æ­¥éª¤ 1: ç¯å¢ƒæ£€æŸ¥
      - name: ç¯å¢ƒæ£€æŸ¥
        script: |
          echo "========================================="
          echo "ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ"
          echo "========================================="
          flutter --version
          pod --version
          xcodebuild -version
          echo "========================================="
      
      # æ­¥éª¤ 2: Flutter å‡†å¤‡
      - name: Flutter å‡†å¤‡
        script: |
          echo "========================================="
          echo "ğŸ“¦ å‡†å¤‡ Flutter ä¾èµ–"
          echo "========================================="
          flutter clean
          flutter pub get
          echo "âœ… Flutter ä¾èµ–å‡†å¤‡å®Œæˆ"
          echo "========================================="
      
      # æ­¥éª¤ 3: ä¿®å¤ pubspec.yaml - ç§»é™¤æœ‰é—®é¢˜çš„æ’ä»¶
      - name: ä¿®å¤ä¾èµ–é—®é¢˜
        script: |
          echo "========================================="
          echo "ğŸ”§ ä¿®å¤ share_handler_ios ä¾èµ–é—®é¢˜"
          echo "========================================="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ share_handler æ’ä»¶
          if grep -q "share_handler" pubspec.yaml; then
            echo "å‘ç° share_handler æ’ä»¶"
            
            # å¤‡ä»½åŸæ–‡ä»¶
            cp pubspec.yaml pubspec.yaml.backup
            
            # æ³¨é‡Šæ‰ share_handler (ä¸´æ—¶ç¦ç”¨)
            sed -i.bak 's/^  share_handler:/#  share_handler:/g' pubspec.yaml
            
            echo "å·²ä¸´æ—¶ç¦ç”¨ share_handler æ’ä»¶"
            echo ""
            echo "é‡æ–°è·å–ä¾èµ–..."
            flutter pub get
            
            echo "âœ… ä¾èµ–é—®é¢˜å·²ä¿®å¤"
          else
            echo "æœªå‘ç° share_handler æ’ä»¶,è·³è¿‡ä¿®å¤"
          fi
          echo "========================================="
      
      # æ­¥éª¤ 4: æ·±åº¦æ¸…ç† CocoaPods
      - name: æ·±åº¦æ¸…ç† CocoaPods
        script: |
          echo "========================================="
          echo "ğŸ§¹ æ·±åº¦æ¸…ç† CocoaPods"
          echo "========================================="
          cd ios
          rm -rf Pods Podfile.lock
          rm -rf ~/Library/Caches/CocoaPods
          rm -rf .symlinks Flutter/Flutter.framework Flutter/Flutter.podspec
          rm -rf ~/Library/Developer/Xcode/DerivedData
          pod cache clean --all 2>/dev/null || true
          cd ..
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo "========================================="
      
      # æ­¥éª¤ 5: é…ç½® CocoaPods
      - name: é…ç½® CocoaPods
        script: |
          echo "========================================="
          echo "âš™ï¸  é…ç½® CocoaPods"
          echo "========================================="
          cd ios
          pod repo remove master 2>/dev/null || true
          pod repo add-cdn trunk https://cdn.cocoapods.org/ 2>/dev/null || true
          cd ..
          echo "âœ… é…ç½®å®Œæˆ"
          echo "========================================="
      
      # æ­¥éª¤ 6: æ›´æ–°å’Œå®‰è£… Pods
      - name: å®‰è£… iOS ä¾èµ–
        script: |
          echo "========================================="
          echo "ğŸ“¦ å®‰è£… iOS ä¾èµ–"
          echo "========================================="
          cd ios
          
          echo "æ›´æ–° CocoaPods ä»“åº“..."
          pod repo update
          
          echo ""
          echo "å®‰è£… Pods (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)..."
          pod install --repo-update --verbose 2>&1 | tee ../pod_install.log
          INSTALL_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $INSTALL_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… Pods å®‰è£…æˆåŠŸ"
          else
            echo ""
            echo "âŒ Pods å®‰è£…å¤±è´¥"
            echo ""
            echo "é”™è¯¯æ—¥å¿—:"
            tail -100 ../pod_install.log
            exit 1
          fi
          
          cd ..
          echo "========================================="
      
      # æ­¥éª¤ 7: ç¼–è¯‘ iOS åº”ç”¨
      - name: ç¼–è¯‘ iOS åº”ç”¨
        script: |
          echo "========================================="
          echo "ğŸ”¨ ç¼–è¯‘ iOS åº”ç”¨"
          echo "========================================="
          
          flutter build ios --release --no-codesign 2>&1 | tee flutter_build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
            
            if [ -d "build/ios/iphoneos/Runner.app" ]; then
              echo "âœ… Runner.app å·²ç”Ÿæˆ"
              ls -lh build/ios/iphoneos/Runner.app
            else
              echo "âŒ Runner.app æœªæ‰¾åˆ°"
              exit 1
            fi
          else
            echo ""
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            tail -200 flutter_build.log
            exit 1
          fi
          echo "========================================="
      
      # æ­¥éª¤ 8: æ‰“åŒ… IPA
      - name: æ‰“åŒ…ä¸º IPA
        script: |
          echo "========================================="
          echo "ğŸ“¦ æ‰“åŒ… IPA"
          echo "========================================="
          
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r -q PureLive-TrollStore.ipa Payload
          mv PureLive-TrollStore.ipa ../../../
          rm -rf Payload
          cd ../../..
          
          if [ -f "PureLive-TrollStore.ipa" ]; then
            echo ""
            echo "âœ… IPA æ‰“åŒ…æˆåŠŸ!"
            echo ""
            echo "ğŸ“± æ–‡ä»¶ä¿¡æ¯:"
            ls -lh PureLive-TrollStore.ipa
            echo ""
            echo "ğŸ‰ å¯ä»¥ç”¨ TrollStore å®‰è£…äº†!"
          else
            echo "âŒ IPA æœªç”Ÿæˆ"
            exit 1
          fi
          echo "========================================="
      
      # æ­¥éª¤ 9: æ¢å¤ pubspec.yaml (å¦‚æœä¿®æ”¹è¿‡)
      - name: æ¸…ç†ä¸´æ—¶ä¿®æ”¹
        script: |
          if [ -f "pubspec.yaml.backup" ]; then
            echo "æ¢å¤åŸå§‹ pubspec.yaml..."
            mv pubspec.yaml.backup pubspec.yaml
            echo "âœ… å·²æ¢å¤"
          fi
    
    artifacts:
      - PureLive-TrollStore.ipa
      - "*.log"
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
