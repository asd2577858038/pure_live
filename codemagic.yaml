workflows:
  ios-trollstore:
    name: æ„å»º iOS IPA (TrollStore ç‰ˆ)
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        # CocoaPods ç›¸å…³ç¯å¢ƒå˜é‡
        COCOAPODS_DISABLE_STATS: true
    
    scripts:
      - name: ç¬¬1æ­¥ - å½»åº•æ¸…ç†ç¯å¢ƒ
        script: |
          echo "ğŸ§¹ å½»åº•æ¸…ç†æ„å»ºç¯å¢ƒ..."
          
          # æ¸…ç† Flutter ç¼“å­˜
          flutter clean
          
          # æ¸…ç† iOS æ„å»ºäº§ç‰©
          cd ios
          rm -rf Pods Podfile.lock .symlinks build DerivedData
          
          # æ¸…ç† CocoaPods å…¨å±€ç¼“å­˜
          echo "ğŸ§¹ æ¸…ç† CocoaPods ç¼“å­˜..."
          rm -rf ~/.cocoapods/repos
          rm -rf ~/Library/Caches/CocoaPods
          pod cache clean --all || true
          
          cd ..
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
      
      - name: ç¬¬2æ­¥ - åˆå§‹åŒ– CocoaPods
        script: |
          echo "ğŸ”§ åˆå§‹åŒ– CocoaPods..."
          
          # å®Œå…¨é‡æ–°è®¾ç½® CocoaPods specs
          pod setup
          
          # éªŒè¯ CocoaPods è®¾ç½®
          pod --version
          echo "âœ… CocoaPods åˆå§‹åŒ–å®Œæˆ"
      
      - name: ç¬¬3æ­¥ - è·å– Flutter ä¾èµ–
        script: |
          echo "ğŸ“¦ è·å– Flutter ä¾èµ–..."
          flutter pub get
          
          # éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
          if [ ! -d ".dart_tool" ]; then
            echo "âŒ Flutter ä¾èµ–è·å–å¤±è´¥"
            exit 1
          fi
          echo "âœ… Flutter ä¾èµ–è·å–æˆåŠŸ"
      
      - name: ç¬¬4æ­¥ - æ£€æŸ¥ iOS é…ç½®
        script: |
          echo "ğŸ” æ£€æŸ¥ iOS é…ç½®..."
          
          cd ios
          
          # æ£€æŸ¥ Podfile
          if [ ! -f "Podfile" ]; then
            echo "âŒ Podfile ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "ğŸ“„ Podfile å†…å®¹:"
          cat Podfile
          
          # æ£€æŸ¥ iOS æœ€ä½ç‰ˆæœ¬
          echo ""
          echo "ğŸ“± iOS éƒ¨ç½²ç›®æ ‡:"
          grep -E "platform :ios" Podfile || echo "æœªæ‰¾åˆ° platform è®¾ç½®"
          
          cd ..
          echo "âœ… iOS é…ç½®æ£€æŸ¥å®Œæˆ"
      
      - name: ç¬¬5æ­¥ - æ„å»º iOS åº”ç”¨
        script: |
          echo "ğŸ”¨ å¼€å§‹æ„å»º iOS åº”ç”¨..."
          
          # è®¾ç½®ä¸¥æ ¼æ¨¡å¼
          set -e
          
          # ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
          PROJECT_ROOT=$(pwd)
          echo "ğŸ“ å½“å‰ç›®å½•: $PROJECT_ROOT"
          
          # Flutter æ„å»ºä¼šè‡ªåŠ¨å¤„ç† pod install
          # æ·»åŠ  --verbose æŸ¥çœ‹è¯¦ç»†è¾“å‡º
          echo "ğŸš€ æ‰§è¡Œ Flutter æ„å»º..."
          flutter build ios \
            --release \
            --no-codesign \
            --verbose \
            2>&1 | tee flutter_build.log
          
          # æ£€æŸ¥æ„å»ºæ˜¯å¦çœŸçš„æˆåŠŸ
          BUILD_SUCCESS=$(grep -c "Built.*Runner.app" flutter_build.log || echo "0")
          if [ "$BUILD_SUCCESS" -eq "0" ]; then
            echo "âŒ æ„å»ºå¯èƒ½å¤±è´¥ï¼Œæœªæ‰¾åˆ°æˆåŠŸæ ‡è®°"
            echo "ğŸ“„ æœ€å50è¡Œæ—¥å¿—:"
            tail -50 flutter_build.log
            exit 1
          fi
          
          # éªŒè¯æ„å»ºäº§ç‰©
          echo "ğŸ” æ£€æŸ¥æ„å»ºäº§ç‰©..."
          if [ ! -d "build/ios/iphoneos/Runner.app" ]; then
            echo "âŒ iOS åº”ç”¨æ„å»ºå¤±è´¥ - Runner.app ä¸å­˜åœ¨"
            echo "ğŸ“‚ å½“å‰ç›®å½•ç»“æ„:"
            ls -la build/ 2>/dev/null || echo "build ç›®å½•ä¸å­˜åœ¨"
            ls -la build/ios/ 2>/dev/null || echo "build/ios ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… iOS åº”ç”¨æ„å»ºæˆåŠŸ"
          echo "ğŸ“‚ æ„å»ºäº§ç‰©:"
          ls -lh build/ios/iphoneos/Runner.app
      
      - name: ç¬¬6æ­¥ - æ‰“åŒ… IPA
        script: |
          echo "ğŸ“¦ æ‰“åŒ… IPA æ–‡ä»¶..."
          
          # è®¾ç½®ä¸¥æ ¼æ¨¡å¼
          set -e
          
          PROJECT_ROOT=$(pwd)
          BUILD_DIR="$PROJECT_ROOT/build/ios/iphoneos"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          IPA_NAME="PureLive_${TIMESTAMP}.ipa"
          
          echo "ğŸ“ é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"
          echo "ğŸ“ æ„å»ºç›®å½•: $BUILD_DIR"
          
          # å†æ¬¡éªŒè¯æ„å»ºäº§ç‰©å­˜åœ¨
          if [ ! -d "$BUILD_DIR/Runner.app" ]; then
            echo "âŒ é”™è¯¯: Runner.app ä¸å­˜åœ¨"
            echo "ğŸ“‚ æ£€æŸ¥ç›®å½•ç»“æ„:"
            find build -type d -name "*.app" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½• .app æ–‡ä»¶"
            exit 1
          fi
          
          # è¿›å…¥æ„å»ºç›®å½•
          cd "$BUILD_DIR"
          echo "ğŸ“ å·²åˆ‡æ¢åˆ°: $(pwd)"
          
          # æ¸…ç†å¹¶åˆ›å»º Payload ç›®å½•
          rm -rf Payload
          mkdir -p Payload
          
          # å¤åˆ¶ app åˆ° Payload
          echo "ğŸ“‹ å¤åˆ¶ Runner.app åˆ° Payload..."
          cp -r Runner.app Payload/
          
          # éªŒè¯å¤åˆ¶æˆåŠŸ
          if [ ! -d "Payload/Runner.app" ]; then
            echo "âŒ å¤åˆ¶ Runner.app å¤±è´¥"
            exit 1
          fi
          
          # æ˜¾ç¤º app åŒ…å†…å®¹
          echo "ğŸ“¦ App åŒ…å†…å®¹:"
          ls -lh Payload/Runner.app | head -20
          
          # æ‰“åŒ…æˆ IPA
          echo "ğŸ—œï¸  å‹ç¼© IPA..."
          zip -r "$PROJECT_ROOT/$IPA_NAME" Payload -q
          
          # è¿”å›é¡¹ç›®æ ¹ç›®å½•
          cd "$PROJECT_ROOT"
          
          # éªŒè¯ IPA æ–‡ä»¶
          if [ ! -f "$IPA_NAME" ]; then
            echo "âŒ IPA æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          
          # æ˜¾ç¤º IPA ä¿¡æ¯
          echo "âœ… IPA æ‰“åŒ…æˆåŠŸ!"
          echo "ğŸ“¦ æ–‡ä»¶å: $IPA_NAME"
          ls -lh "$IPA_NAME"
          
          # åˆ›å»ºä¸€ä¸ªå›ºå®šåç§°çš„å‰¯æœ¬ï¼Œæ–¹ä¾¿ä¸‹è½½
          cp "$IPA_NAME" PureLive.ipa
          echo "ğŸ“¦ å·²åˆ›å»ºå‰¯æœ¬: PureLive.ipa"
          
          # æ˜¾ç¤ºæœ€ç»ˆäº§ç‰©
          echo ""
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼äº§ç‰©åˆ—è¡¨:"
          ls -lh *.ipa
    
    artifacts:
      - "*.ipa"
      - flutter_build.log
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
