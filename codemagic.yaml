workflows:
  ios-trollstore:
    name: æ„å»º iOS IPA (TrollStore ç‰ˆ)
    max_build_duration: 120
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        COCOAPODS_DISABLE_STATS: "true"
    
    scripts:
      - name: æ­¥éª¤1 - ç¯å¢ƒä¿¡æ¯
        script: |
          set -e
          echo "ğŸ”§ æ„å»ºç¯å¢ƒä¿¡æ¯..."
          flutter --version
          xcodebuild -version
          pod --version
          ruby --version
          echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"
          
      - name: æ­¥éª¤2 - æ¸…ç†ç¯å¢ƒ
        script: |
          set -e
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ..."
          flutter clean
          cd ios
          rm -rf Pods Podfile.lock .symlinks build DerivedData
          cd ..
          echo "âœ… æ¸…ç†å®Œæˆ"
      
      - name: æ­¥éª¤3 - å®Œå…¨é‡å»º CocoaPods
        script: |
          set -e
          echo "ğŸ”„ å®Œå…¨é‡å»º CocoaPods specs..."
          
          # åˆ é™¤æ‰€æœ‰ CocoaPods ç¼“å­˜å’Œä»“åº“
          rm -rf ~/.cocoapods
          rm -rf ~/Library/Caches/CocoaPods
          
          # é‡æ–°åˆå§‹åŒ–ï¼ˆä¼šä» CDN ä¸‹è½½æœ€æ–° specsï¼‰
          pod setup
          
          # éªŒè¯è®¾ç½®
          echo "ğŸ“‹ CocoaPods é…ç½®:"
          pod env | grep -A 5 "Repos"
          
          echo "âœ… CocoaPods é‡å»ºå®Œæˆ"
      
      - name: æ­¥éª¤4 - è·å– Flutter ä¾èµ–
        script: |
          set -e
          echo "ğŸ“¦ è·å– Flutter ä¾èµ–..."
          flutter pub get
          
          if [ ! -d ".dart_tool" ]; then
            echo "âŒ ä¾èµ–è·å–å¤±è´¥"
            exit 1
          fi
          echo "âœ… ä¾èµ–è·å–æˆåŠŸ"
      
      - name: æ­¥éª¤5 - ç¡®ä¿ Podfile ä½¿ç”¨ CDN
        script: |
          set -e
          cd ios
          
          echo "ğŸ“ é…ç½® Podfile..."
          
          # å¤‡ä»½
          cp Podfile Podfile.backup
          
          # ç¡®ä¿ä½¿ç”¨ CDN æº
          if ! grep -q "source 'https://cdn.cocoapods.org/'" Podfile; then
            # åœ¨ç¬¬ä¸€è¡Œæ’å…¥ CDN æº
            sed -i.bak '1i\
source '\''https://cdn.cocoapods.org/'\''
' Podfile
          fi
          
          echo "ğŸ“„ Podfile å‰10è¡Œ:"
          head -10 Podfile
          
          cd ..
          echo "âœ… Podfile é…ç½®å®Œæˆ"
      
      - name: æ­¥éª¤6 - æ‰‹åŠ¨è¿è¡Œ pod install
        script: |
          set -e
          cd ios
          
          echo "ğŸ“¦ æ‰‹åŠ¨å®‰è£… CocoaPods ä¾èµ–..."
          echo "â° è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼ˆæ­£åœ¨ä¸‹è½½ FFmpeg ç­‰å¤§å‹æ¡†æ¶ï¼‰..."
          
          # æ‰‹åŠ¨è¿è¡Œ pod installï¼ˆä¸é€šè¿‡ Flutterï¼‰
          pod install --repo-update --verbose 2>&1 | tee pod_install.log
          
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          if [ ! -d "Pods" ]; then
            echo "âŒ Pod å®‰è£…å¤±è´¥"
            echo "ğŸ“„ æœ€å100è¡Œæ—¥å¿—:"
            tail -100 pod_install.log
            exit 1
          fi
          
          if [ ! -f "Runner.xcworkspace/contents.xcworkspacedata" ]; then
            echo "âŒ Workspace åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… Pod å®‰è£…æˆåŠŸ"
          echo "ğŸ“‚ Pods ç›®å½•:"
          ls -la Pods/ | head -20
          
          cd ..
      
      - name: æ­¥éª¤7 - ä½¿ç”¨ xcodebuild ç›´æ¥æ„å»ºï¼ˆè·³è¿‡ Flutter çš„ pod æ£€æŸ¥ï¼‰
        script: |
          set -e
          
          echo "ğŸ”¨ ä½¿ç”¨ xcodebuild ç›´æ¥æ„å»º..."
          
          cd ios
          
          # ä½¿ç”¨ xcodebuild ç›´æ¥æ„å»º
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath $PWD/build/Runner.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | tee xcodebuild.log
          
          # æ£€æŸ¥ archive æ˜¯å¦æˆåŠŸ
          if [ ! -d "build/Runner.xcarchive" ]; then
            echo "âŒ Archive å¤±è´¥"
            echo "ğŸ“„ æœ€å100è¡Œæ—¥å¿—:"
            tail -100 xcodebuild.log
            exit 1
          fi
          
          # å¯¼å‡º app
          echo "ğŸ“¦ å¯¼å‡º app..."
          cd build/Runner.xcarchive/Products/Applications
          
          if [ ! -d "Runner.app" ]; then
            echo "âŒ Runner.app ä¸å­˜åœ¨"
            ls -la
            exit 1
          fi
          
          # å¤åˆ¶åˆ°æ ‡å‡†ä½ç½®
          mkdir -p $PWD/../../../build/ios/iphoneos
          cp -r Runner.app $PWD/../../../build/ios/iphoneos/
          
          cd $PWD/../../../..
          
          echo "âœ… æ„å»ºæˆåŠŸ"
          echo "ğŸ“‚ æ„å»ºäº§ç‰©:"
          ls -lh build/ios/iphoneos/Runner.app
      
      - name: æ­¥éª¤8 - æ‰“åŒ… IPA
        script: |
          set -e
          
          echo "ğŸ“¦ æ‰“åŒ… IPA..."
          
          PROJECT_ROOT=$(pwd)
          BUILD_DIR="$PROJECT_ROOT/build/ios/iphoneos"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          IPA_NAME="PureLive_${TIMESTAMP}.ipa"
          
          # éªŒè¯ app å­˜åœ¨
          if [ ! -d "$BUILD_DIR/Runner.app" ]; then
            echo "âŒ Runner.app ä¸å­˜åœ¨"
            find build -type d -name "*.app" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½• app"
            exit 1
          fi
          
          cd "$BUILD_DIR"
          
          # åˆ›å»º Payload
          rm -rf Payload
          mkdir -p Payload
          cp -r Runner.app Payload/
          
          # æ‰“åŒ…
          echo "ğŸ—œï¸  å‹ç¼©..."
          zip -r "$PROJECT_ROOT/$IPA_NAME" Payload -q
          
          cd "$PROJECT_ROOT"
          
          # éªŒè¯
          if [ ! -f "$IPA_NAME" ]; then
            echo "âŒ IPA æ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          
          # åˆ›å»ºå›ºå®šåç§°å‰¯æœ¬
          cp "$IPA_NAME" PureLive.ipa
          
          echo "âœ… æ‰“åŒ…æˆåŠŸ!"
          echo "ğŸ“¦ äº§ç‰©åˆ—è¡¨:"
          ls -lh *.ipa
    
    artifacts:
      - "*.ipa"
      - "ios/pod_install.log"
      - "ios/xcodebuild.log"
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
