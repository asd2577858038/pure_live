workflows:
  # iOS TrollStore æ„å»º - æœ€ç»ˆä¼˜åŒ–ç‰ˆ
  ios-trollstore-build:
    name: iOS TrollStore æ„å»º
    max_build_duration: 60
    instance_type: mac_mini_m2
    
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        # è®¾ç½® CocoaPods ä½¿ç”¨ CDN
        COCOAPODS_TRUNK_URL: "https://cdn.cocoapods.org/"
    
    scripts:
      # æ­¥éª¤ 1: ç¯å¢ƒå‡†å¤‡
      - name: ç¯å¢ƒæ£€æŸ¥
        script: |
          echo "========================================="
          echo "ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ"
          echo "========================================="
          flutter --version
          pod --version
          xcodebuild -version
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "========================================="
      
      # æ­¥éª¤ 2: Flutter æ¸…ç†å’Œä¾èµ–è·å–
      - name: Flutter å‡†å¤‡
        script: |
          echo "========================================="
          echo "ğŸ“¦ å‡†å¤‡ Flutter ä¾èµ–"
          echo "========================================="
          
          # æ¸…ç†ä¹‹å‰çš„æ„å»º
          echo "æ¸…ç†æ—§æ„å»º..."
          flutter clean
          
          # è·å–ä¾èµ–
          echo "è·å– Flutter ä¾èµ–..."
          flutter pub get
          
          if [ $? -eq 0 ]; then
            echo "âœ… Flutter ä¾èµ–å‡†å¤‡å®Œæˆ"
          else
            echo "âŒ Flutter ä¾èµ–è·å–å¤±è´¥"
            exit 1
          fi
          echo "========================================="
      
      # æ­¥éª¤ 3: æ·±åº¦æ¸…ç† CocoaPods
      - name: æ·±åº¦æ¸…ç† CocoaPods
        script: |
          echo "========================================="
          echo "ğŸ§¹ æ·±åº¦æ¸…ç† CocoaPods"
          echo "========================================="
          
          cd ios
          
          # åˆ é™¤æ‰€æœ‰ CocoaPods ç›¸å…³æ–‡ä»¶
          echo "åˆ é™¤ Pods ç›®å½•..."
          rm -rf Pods
          
          echo "åˆ é™¤ Podfile.lock..."
          rm -rf Podfile.lock
          
          echo "æ¸…ç†å…¨å±€ CocoaPods ç¼“å­˜..."
          rm -rf ~/Library/Caches/CocoaPods
          
          echo "æ¸…ç† CocoaPods æœ¬åœ° repo..."
          pod cache clean --all 2>/dev/null || true
          
          # æ¸…ç† Flutter ç”Ÿæˆæ–‡ä»¶
          echo "æ¸…ç† Flutter é“¾æ¥æ–‡ä»¶..."
          rm -rf .symlinks
          rm -rf Flutter/Flutter.framework
          rm -rf Flutter/Flutter.podspec
          rm -rf Flutter/App.framework
          
          # æ¸…ç† Xcode ç¼“å­˜
          echo "æ¸…ç† Xcode DerivedData..."
          rm -rf ~/Library/Developer/Xcode/DerivedData
          
          cd ..
          
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo "========================================="
      
      # æ­¥éª¤ 4: é…ç½® CocoaPods ä½¿ç”¨ CDN
      - name: é…ç½® CocoaPods CDN
        script: |
          echo "========================================="
          echo "âš™ï¸  é…ç½® CocoaPods CDN"
          echo "========================================="
          
          cd ios
          
          # ç§»é™¤æ—§çš„ master repo (å¦‚æœå­˜åœ¨)
          echo "ç§»é™¤æ—§çš„ master repo..."
          pod repo remove master 2>/dev/null || true
          
          # ç¡®ä¿ä½¿ç”¨ CDN trunk
          echo "æ·»åŠ  CDN trunk..."
          pod repo add-cdn trunk https://cdn.cocoapods.org/ 2>/dev/null || true
          
          # æ˜¾ç¤ºå½“å‰ repo åˆ—è¡¨
          echo "å½“å‰ CocoaPods repos:"
          pod repo list
          
          cd ..
          
          echo "âœ… CDN é…ç½®å®Œæˆ"
          echo "========================================="
      
      # æ­¥éª¤ 5: æ›´æ–° CocoaPods ä»“åº“
      - name: æ›´æ–° CocoaPods ä»“åº“
        script: |
          echo "========================================="
          echo "ğŸ“¥ æ›´æ–° CocoaPods ä»“åº“"
          echo "========================================="
          
          cd ios
          
          echo "å¼€å§‹æ›´æ–° specs repository..."
          pod repo update
          
          if [ $? -eq 0 ]; then
            echo "âœ… CocoaPods ä»“åº“æ›´æ–°æˆåŠŸ"
          else
            echo "âš ï¸  æ›´æ–°å¤±è´¥,å°è¯•ç»§ç»­..."
          fi
          
          cd ..
          echo "========================================="
      
      # æ­¥éª¤ 6: å®‰è£… Pods (å…³é”®æ­¥éª¤)
      - name: å®‰è£… iOS ä¾èµ–
        script: |
          echo "========================================="
          echo "ğŸ“¦ å®‰è£… iOS ä¾èµ– (CocoaPods)"
          echo "========================================="
          
          cd ios
          
          # ä½¿ç”¨ --repo-update ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ specs
          echo "å¼€å§‹å®‰è£… Pods..."
          echo "è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´..."
          
          pod install --repo-update --verbose 2>&1 | tee ../pod_install.log
          INSTALL_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $INSTALL_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… Pods å®‰è£…æˆåŠŸ"
            echo ""
            echo "å·²å®‰è£…çš„ Pods:"
            ls -1 Pods | grep -v "Headers\|Target Support Files\|Local Podspecs" | head -20
          else
            echo ""
            echo "âŒ Pods å®‰è£…å¤±è´¥"
            echo ""
            echo "é”™è¯¯æ—¥å¿— (æœ€å 100 è¡Œ):"
            tail -100 ../pod_install.log
            echo ""
            echo "æŸ¥æ‰¾å…³é”®é”™è¯¯:"
            grep -i "error\|fatal" ../pod_install.log | tail -20
            exit 1
          fi
          
          cd ..
          echo "========================================="
      
      # æ­¥éª¤ 7: ç¼–è¯‘ iOS åº”ç”¨
      - name: ç¼–è¯‘ iOS åº”ç”¨
        script: |
          echo "========================================="
          echo "ğŸ”¨ ç¼–è¯‘ iOS åº”ç”¨"
          echo "========================================="
          
          echo "å¼€å§‹ç¼–è¯‘ (Release æ¨¡å¼, æ— ç­¾å)..."
          echo "è¿™å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ..."
          echo ""
          
          # ä½¿ç”¨ -v è¯¦ç»†æ¨¡å¼,ä½†åªä¿å­˜åˆ°æ—¥å¿—æ–‡ä»¶
          flutter build ios --release --no-codesign 2>&1 | tee flutter_build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… ç¼–è¯‘æˆåŠŸ"
          else
            echo ""
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo ""
            echo "ç¼–è¯‘æ—¥å¿— (æœ€å 200 è¡Œ):"
            tail -200 flutter_build.log
            echo ""
            echo "æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯:"
            grep -i "error\|failed" flutter_build.log | tail -30
            exit 1
          fi
          
          # éªŒè¯ç¼–è¯‘äº§ç‰©
          echo ""
          echo "éªŒè¯ç¼–è¯‘äº§ç‰©..."
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            echo "âœ… Runner.app å·²ç”Ÿæˆ"
            echo ""
            echo "App ä¿¡æ¯:"
            ls -lh build/ios/iphoneos/Runner.app
            echo ""
            echo "App å¤§å°:"
            du -sh build/ios/iphoneos/Runner.app
          else
            echo "âŒ Runner.app æœªæ‰¾åˆ°"
            echo ""
            echo "build ç›®å½•å†…å®¹:"
            find build -type d -maxdepth 3 2>/dev/null || echo "build ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "========================================="
      
      # æ­¥éª¤ 8: æ‰“åŒ… IPA
      - name: æ‰“åŒ…ä¸º IPA
        script: |
          echo "========================================="
          echo "ğŸ“¦ æ‰“åŒ… IPA (TrollStore æ ¼å¼)"
          echo "========================================="
          
          # æœ€åæ£€æŸ¥
          if [ ! -d "build/ios/iphoneos/Runner.app" ]; then
            echo "âŒ é”™è¯¯: Runner.app ä¸å­˜åœ¨,æ— æ³•æ‰“åŒ…"
            exit 1
          fi
          
          echo "è¿›å…¥æ„å»ºç›®å½•..."
          cd build/ios/iphoneos
          
          echo "åˆ›å»º Payload ç»“æ„..."
          mkdir -p Payload
          
          echo "å¤åˆ¶åº”ç”¨ç¨‹åº..."
          cp -r Runner.app Payload/Runner.app
          
          echo "æ‰“åŒ…ä¸º IPA..."
          zip -r -q PureLive-TrollStore.ipa Payload
          
          echo "ç§»åŠ¨ IPA åˆ°æ ¹ç›®å½•..."
          mv PureLive-TrollStore.ipa ../../../
          
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf Payload
          
          cd ../../..
          
          # éªŒè¯ IPA
          if [ -f "PureLive-TrollStore.ipa" ]; then
            echo ""
            echo "âœ… IPA æ‰“åŒ…æˆåŠŸ!"
            echo ""
            echo "ğŸ“± æ–‡ä»¶ä¿¡æ¯:"
            ls -lh PureLive-TrollStore.ipa
            echo ""
            FILE_SIZE=$(ls -lh PureLive-TrollStore.ipa | awk '{print $5}')
            echo "ğŸ“¦ IPA å¤§å°: $FILE_SIZE"
            echo ""
            echo "ğŸ‰ å¯ä»¥ç”¨ TrollStore å®‰è£…äº†!"
            echo ""
            echo "IPA å†…å®¹é¢„è§ˆ (å‰ 20 é¡¹):"
            unzip -l PureLive-TrollStore.ipa | head -25
          else
            echo "âŒ IPA æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
          echo "========================================="
    
    # ä¿å­˜æ„å»ºäº§ç‰©
    artifacts:
      - PureLive-TrollStore.ipa
      - "*.log"
    
    # é‚®ä»¶é€šçŸ¥ (å¯é€‰)
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true
